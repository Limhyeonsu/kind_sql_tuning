# 조인튜닝
## 4.1 NL조인
조인의 기본은 NL조인이다. NL조인은 인덱스를 이용한 조인이기 때문에 조인 원리도 그대로 적용할 수 있다.

### 4.1.1 기본 메커니즘
NL조인은 Outer와 Inner 양쪽 테이블 모두 인덱스를 이용한다. Outer쪽 테이블은 사이즈가 크지 않으면 인덱스를 이용하지 않을 수 있다. 반면 Inner 테이블은 인덱스를 사용해야한다.

### 4.1.2 NL조인 실행계획 제어
    select /*+ ordered use_nl(c) */
        e.사원명, e.고객명, e.전화번호
    from e.입사일자 >= '19960101'
    and c.관리사원번호 = e.사원번호

ordered 힌트는 FROM 절에서 기술한 순서대로 조인하라고 옵티마이저에 지시할 때 사용한다. use_nl 힌트는 NL 방식으로 조인하라고 지시할 때 사용한다. 이 힌트를 사용하면 FROM 절을 바꾸지 않고도 마음껏 순서를 제어할 수 있다. ordered를 기술하지 않는 경우 조인 순서는 옵티마이저가 스스로 정한다.

### 4.1.3 NL조인 수행 과정 분석
    --인덱스 구성:사원pk(사원번호), 사원_X1(입사일자), 고객pk(고객번호), 고객_X1(관리사원번호), 고객_X2(최종주문금액)
    select /*+ ordered use_nl(c) index(e) index(c) */
    e.사원번호, e.사원명, e.입사일자,
    c.고객번호, c.고객명, c.전화번호, c.최종주문금액
    from 사원 e, 고객 c
    where c.관리번호 = 사원번호       --1
    and e.입사일자 >= '19960101'    --2
    and e.부서코드 >= 'Z123'        --3
    and c.최종주문금액 >= 20000      --4

조건절 비교 순서는 2->3->1->4 순이다. 

### 4.1.4 NL조인 튜닝 포인트
264p

__올바른 조인 메소드 선택__ : OLTP 시스템에서 튜닝할 때는 일차적으로 NL조인부터 고려하는 것이 올바른 순서다. 성능이 느리다면 과도한 랜덤 액세스가 발생하는 지점을 우선 파악하고, 조인 순서를 변경해서 랜덤 액세스 발생량을 줄일 수 있는지 더 효과적인 다른 인덱스가 있는지 등을 검토한다. 만약 NL조인이 좋은 성능을 내기 어렵다고 판단될 때는 소트 머지 조인이나 해시 조인을 검토한다.

### 4.1.5 NL조인 특징 요약
1) NL조인은 랜덤 액세스 위주의 조인 방식이다.(대량 데이터 조인시 불리함)
2) 조인을 한 레코드 씩 순차적으로 진행한다.
3) 다른 조인 방식과 비교시 인덱스 구성 전략이 특히 중요하다. 조인컬럼에 대한 인덱스가 있느냐 없느냐, 있다면 구성이 어떻게 되어있는냐에 따라 조인 효율이 크게 달라진다.

1번의 특징 때문에 대량 처리시 치명적인 한계를 드러내지만 2번 특징으로 인하여 큰 테이블을 조인하더라도 빠른 응답속도를 낸다.

정리) NL조인은 소량 데이터를 주로 처리하거나 부분 범위 처리가 가능한 온라인 트랜잭션처리(OLTP)시스템에 적합한 조인 방식이다.

### 4.1.6 NL조인 튜닝 실습
266~269p

### 4.1.7 NL조인 확장 메커니즘
버전이 올라가면서 오라클은 NL조인 성능을 높이기 위해 테이블 Prefetch, 배치 I/O 기능을 도입했다. Prefetch는 인덱스를 이용해 테이블을 액세스하다가 디스크 I/O가 필요해지면 이어서 곧 읽게 될 블록까지 미리 읽어서 버퍼캐시에 적재하는 기능이다. 배치 I/O는 디스크 I/O Call을 미뤘다가 읽을 블록이 일정량 쌓이면 한꺼번에 처리하는 기능이다.